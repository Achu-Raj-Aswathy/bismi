<%- include('./partials/header') %>
	<%- include('./partials/userHeader') %>

		<!-- **************** MAIN CONTENT START **************** -->
		<main>

			<!-- =======================
    Content START -->
			<section class="pt-3">
				<div class="container-fluid">

					<div class="row g-2 g-lg-4">

						<!-- Sidebar START -->
						<!-- Sidebar END -->

						<!-- Main content START -->
						<!-- <div class="col-lg-8 col-xl-9 ps-xl-5"> -->

						<!-- Offcanvas menu button -->
						<div class="d-grid mb-0 d-lg-none w-100">
							<button class="btn btn-primary mb-4" type="button" data-bs-toggle="offcanvas"
								data-bs-target="#offcanvasSidebar" aria-controls="offcanvasSidebar">
								<i class="fas fa-sliders-h"></i> Menu
							</button>
						</div>

<!-- Counter START -->
<div class="row g-4">
			
	<!-- Earning item -->
	<div class="col-md-6 col-xl-4">
		<div class="card card-body border p-4 h-100">
			<h6>May Total Sales
				<a tabindex="0" class="h6 mb-0" role="button" data-bs-toggle="popover" data-bs-trigger="focus" data-bs-placement="top" data-bs-content="After US royalty withholding tax" data-bs-original-title="" title="">
					<i class="bi bi-info-circle-fill small"></i>
				</a>
			</h6>
			<h2 class="text-success">₹ 25,869</h2>
			<p class="mb-2"><span class="text-danger me-1">102</span> Total Bookings</p>
			<div class="mt-auto text-primary-hover"><a href="#" class="text-decoration-underline p-0 mb-0">View statement</a></div>
		</div>
	</div>

	<!-- Booked Rooms item -->
	<div class="col-md-6 col-xl-4">
		<div class="card card-body border p-4 h-100">
			<h6>May Payout Done</h6>
			<h2 class="text-info">₹ 15869</h2>
			<p class="mb-2"><span class="text-danger me-1">102</span>75 Paid Booking</p>
			<div class="mt-auto text-primary-hover"><a href="#" class="text-decoration-underline p-0 mb-0">View Bookings</a></div>
		</div>
	</div>

	<!-- Available Rooms item -->
	<div class="col-md-6 col-xl-4">
		<div class="card card-body border p-4 h-100">
			<h6>May Payout Pending</h6>
			<h2 class="text-warning">42</h2>
			<p class="mb-2"><span class="text-danger me-1">27</span>Pending Payout Booking</p>
			<div class="mt-auto text-primary-hover"><a href="#" class="text-decoration-underline p-0 mb-0">View Bookings</a></div>
		</div>
	</div>

</div>
<!-- Counter END -->
						<div class="card border">
							<!-- Card header -->
							<div class="card-header border-bottom d-flex justify-content-between align-items-center">
								<h4 class="card-header-title">My Listings
									<!-- <span class="badge bg-primary bg-opacity-10 text-primary ms-2">5 Items</span> -->
								</h4>
								<div class="d-grid"><a href="/add-listing" class="btn btn-primary-soft mb-0"><i
											class="bi bi-plus-lg fa-fw"></i> New Listing</a></div>
							</div>

							<!-- Card body START -->
							<div class="card-body">
								<div class="table-responsive border-0">
									<table class="table align-middle p-4 mb-0 table-hover table-shrink">
										<!-- Table head -->
										<thead class="table-light">
											<tr>
												<th scope="col" class="border-0">Inventory Name</th>
												<th scope="col" class="border-0">Created Date</th>
												<th scope="col" class="border-0">Sector</th>
												<th scope="col" class="border-0">Flight Number</th>
												<th scope="col" class="border-0">Total Live Seats</th>
												<th scope="col" class="border-0">Total Sold Seats</th>
												<th scope="col" class="border-0">Disable Before <div>Departure</div></th>
												<th scope="col" class="border-0">Status</th>
												<th scope="col" class="border-0 rounded-end"></th>
											</tr>
										</thead>

										<!-- Table body START -->
										<tbody class="border-top-0">
											<% if (flights.length===0) { %>
												<tr>
													<td colspan="7" class="text-center">No inventories found.
													</td>
												</tr>
												<% } else { %>
													<% flights.forEach((flight, index)=> { %>
														<tr class="align-middle border-top">
															<td>
																<div>
																	<strong class="text-primary">
																	<%= flight.inventoryName.toUpperCase() %>
																	</strong>
																</div>
																<div class="text-muted">
																	Inventory Start & End Date
																</div>
																<div>
																	<strong>
																	<%= new Date(flight.departureDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) %> - 
																	<%= new Date(flight.arrivalDate).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }) %>
																	</strong>
																</div>	  
															</td>
															<td>
																<strong><%= new Date(flight.createdAt).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' }) %></strong>
															</td>
															<td>
																<div class="text-muted">
																	One Way
																</div>
																<div>
																	<strong><%= flight.from %> - <%= flight.to %></strong>
																</div>
																<div class="text-muted">
																	Departure and Arrival Time
																</div>
																<div>
																	<strong><%= flight.departureTime %> - <%= flight.arrivalTime %></strong>
																</div>
															</td>
															<td>
																<strong><%= flight.stops[0].airlineCode %> - <%= flight.stops[0].flightNumber %></strong>
															</td>
															<td>
																<strong><%= flight.inventoryDates[0].seats %></strong>
															</td>
															<td>
																<strong><%= flight.inventoryDates[0].seatsBooked %></strong>
															</td>
															<td>
																<strong>
																		<%= flight.disableBeforeDays %> 
																		<%= flight.disableBeforeDays == 1 ? "Day" : "Days" %>
																</strong>
															</td>
															<!-- <td>
																<label class="custom-switch">
																	<input type="checkbox" class="changeStatusToggle"
																		data-id="<%= flight._id %>"
																		data-status="<%= flight.status === 'active' ? 'inactive' : 'active' %>">
																	<span class="slider">
																		<span class="label-on"
																			style="font-size: xx-small;"> &nbsp;
																			Active</span>
																		<span class="label-off"
																			style="font-size: xx-small;">Inactive &nbsp;
																		</span>
																	</span>
																</label>
															</td> -->
															<td>
																<div style="display: flex; align-items: center; gap: 8px; flex-direction: column;">
																	<span style="font-size: small;">
																		<%= flight.status == "active" ? "Active" : "Inactive" %>
																	</span>
																	<label class="custom-switch">
																		<input type="checkbox" class="changeStatusToggle"
																			<%= flight.status == "active" ? "checked" : "" %>
																			data-id="<%= flight._id %>"
																			data-status="<%= flight.status == "active" ? "inactive" : "active" %>">
																		<span class="slider"></span>
																	</label>
																</div>
															</td>
															

															<td>
																<!-- Edit Days Button -->
																<a href="#" class="btn btn-sm btn-light"
																	data-bs-toggle="modal" data-bs-target="#dateModal"
																	data-flight="<%= JSON.stringify(flight) %>"
																	data-bs-placement="top" title="Edit Days">
																	<i class="fa-solid fa-calendar-days"></i>
																</a>

																<!-- Edit Seats Button -->
																<a href="#" class="btn btn-sm btn-light"
																	data-bs-toggle="modal" data-bs-target="#seatModal"
																	data-flight="<%= JSON.stringify(flight) %>"
																	data-bs-placement="top" title="Edit Seats">
																	<i class="fa-solid fa-chair"></i>
																</a>
																<!-- Edit Button -->
																<!-- <a href="#" class="btn btn-sm btn-light"
																	data-bs-toggle="modal" data-bs-target="#flightModal"
																	data-flight="<%= JSON.stringify(flight) %>"
																	data-bs-toggle="tooltip" data-bs-placement="top"
																	title="Edit Inventory">
																	<i class="fa-solid fa-pen-to-square"></i>
																</a> -->
																<a href="#"
																	class="btn btn-sm btn-light user-booking-btn"
																	data-flight-id="<%= flight._id %>"
																	title="User Bookings">
																	<i class="fa-solid fa-pen-to-square"></i>
																</a>

															</td>


														</tr>
														<% }); %>
															<% } %>
										</tbody>

										<!-- Table body END -->
									</table>
								</div>
							</div>
							<!-- Card body END -->

							<!-- Card footer START -->

							<!-- Card footer END -->

						</div>
						<!-- </div> -->
					</div>
					<!-- Listing table END -->
				</div>
			</section>
			<!-- =======================
    Content END -->

			<div class="modal fade" id="flightModal" tabindex="-1" aria-labelledby="flightModalLabel"
				aria-hidden="true">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="flightModalLabel">Update Flight</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>

						<div class="modal-body">
							<form id="flightForm">
								<input type="hidden" name="flightId" id="flightId">
								<div class="row g-3">
									<!-- Row 1 -->
									<div class="col-md-3">
										<label class="form-label">Inventory Name</label>
										<input type="text" class="form-control" id="inventoryName">
									</div>

									<div class="col-md-4">
										<label class="form-label">From</label>
										<input type="text" class="form-control" id="from">
									</div>

									<div class="col-md-4">
										<label class="form-label">To</label>
										<input type="text" class="form-control" id="to">
									</div>

									<div class="col-md-3">
										<label class="form-label">From Code</label>
										<input type="text" class="form-control" id="fromCode">
									</div>

									<div class="col-md-3">
										<label class="form-label">To Code</label>
										<input type="text" class="form-control" id="toCode">
									</div>

									<div class="col-md-3">
										<label class="form-label">Departure Date</label>
										<input type="text" class="form-control dateInput" id="departureDate">
									</div>

									<div class="col-md-3">
										<label class="form-label">Arrival Date</label>
										<input type="text" class="form-control dateInput" id="arrivalDate">
									</div>

									<div class="col-md-3">
										<label class="form-label">Departure Time</label>
										<input type="time" class="form-control" id="departureTime">
									</div>

									<div class="col-md-3">
										<label class="form-label">Arrival Time</label>
										<input type="time" class="form-control" id="arrivalTime">
									</div>

									<div class="col-md-3">
										<label class="form-label">Duration(in sec)</label>
										<input type="text" class="form-control" id="duration">
									</div>

									<div class="col-md-3">
										<label class="form-label">From City</label>
										<input type="text" class="form-control" id="fromCity">
									</div>

									<div class="col-md-3">
										<label class="form-label">To City</label>
										<input type="text" class="form-control" id="toCity">
									</div>

									<div class="col-md-3">
										<label class="form-label">From Country</label>
										<input type="text" class="form-control" id="fromCountry">
									</div>

									<div class="col-md-3">
										<label class="form-label">To Country</label>
										<input type="text" class="form-control" id="toCountry">
									</div>

									<!-- Row 2 -->

									<div id="stopsContainer" class="row g-3 stop-block"></div>

									<!-- Row 3 -->
									<div class="col-md-3">
										<label class="form-label">PNR</label>
										<input type="text" class="form-control" id="pnr">
									</div>

									<div class="col-md-3">
										<label class="form-label">Seats</label>
										<input type="number" class="form-control" id="seats">
									</div>

									<div class="col-md-3">
										<label class="form-label">Adults ₹</label>
										<input type="number" class="form-control" id="adults">
									</div>

									<div class="col-md-3">
										<label class="form-label">Infants ₹</label>
										<input type="number" class="form-control" id="infants">
									</div>

									<div class="col-md-3">
										<label class="form-label">Cabin Weight</label>
										<input type="text" class="form-control" id="cab">
									</div>

									<div class="col-md-3">
										<label class="form-label">CheckIn Weight</label>
										<input type="text" class="form-control" id="checkin">
									</div>

									<div class="col-md-3">
										<label class="form-label">Status</label>
										<select class="form-select" id="status">
											<option value="active">Active</option>
											<option value="inactive">Inactive</option>
										</select>
									</div>

								</div>
							</form>
						</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
							<button type="submit" id="updateFlightBtn" class="btn btn-primary">Update</button>
						</div>
					</div>
				</div>
			</div>

			<div class="modal fade w-100" id="seatModal" tabindex="-1" aria-labelledby="seatModalLabel" aria-hidden="true">
				<div class="modal-dialog w-100" style="max-width: 100%;">
					<div class="modal-content">

						<div class="modal-header">
							<h5 class="modal-title" id="seatModalLabel">Inventory List</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>

						<div class="modal-body" style="padding: 0;">
							<form id="seatForm">
								<input type="hidden" name="inventoryId" id="inventoryId">

								<!-- <div class="row g-3">
									<div class="col-md-4">
										<label class="form-label">Travel Date</label>
										<input type="text" class="form-control" id="travelDate" readonly>
									</div>

									<div class="col-md-4">
										<label class="form-label">PNR</label>
										<input type="text" class="form-control" id="pnr">
									</div>

									<div class="col-md-4">
										<label class="form-label">Seats Booked</label>
										<input type="text" class="form-control" id="seatsBooked" readonly>
									</div>

									<div class="col-md-4">
										<label class="form-label">Total Seats</label>
										<input type="number" class="form-control" id="totalSeats">
									</div>

									<div class="col-md-4">
										<label class="form-label">Fare Amount (Adults)</label>
										<input type="number" class="form-control" id="fareAdults">
									</div>

									<div class="col-md-4">
										<label class="form-label">Fare Amount (Infants)</label>
										<input type="number" class="form-control" id="fareInfants">
									</div>

									<div class="col-md-4">
										<label class="form-label">Disable Before Departure (Days)</label>
										<input type="number" class="form-control" id="disableBeforeDeparture">
									</div>

									<div class="col-md-4">
										<label class="form-label">Status</label>
										<select class="form-select" id="status">
											<option value="active">Active</option>
											<option value="disable">Disable</option>
										</select>
									</div>
								</div> -->

								<div class="table-responsive">
									<table class="table custom-border text-center p-0" style="font-size: 0.9em;">
									  <thead class="table-light">
										<tr>
										  <th>Travel Date</th>
										  <th>PNR</th>
										  <th>Seats Booked</th>
										  <th>Total Seats</th>
										  <th>Fare Amount Adults(12y+)</th>
										  <th>Fare-Infants(Below 2y)</th>
										  <th>Disable Before Departure</th>
										  <th>Status</th>
										  <th>ACTION</th>
										</tr>
									  </thead>
									  <tbody class="table-light">
										<tr>
										  <td><input type="text" class="form-control-plaintext text-center text-dark" id="travelDate" disabled></td>
										  <td><input type="text" class="form-control-plaintext text-center text-dark" id="pnr" readonly></td>
										  <td><input type="text" class="form-control-plaintext text-center text-dark" id="seatsBooked" readonly></td>
										  <td><input type="text" class="form-control border-0 text-center text-dark" id="totalSeats" required onkeypress='return event.charCode >= 48 && event.charCode <= 57'></td>
										  <td><input type="text" class="form-control border-0 text-center text-dark" id="fareAdults" required onkeypress='return event.charCode >= 48 && event.charCode <= 57'></td>
										  <td><input type="text" class="form-control border-0 text-center text-dark" id="fareInfants" required onkeypress='return event.charCode >= 48 && event.charCode <= 57'></td>
										  <td><input type="text" class="form-control-plaintext text-center text-dark" id="disableBeforeDays" readonly></td>
										  <td><input type="text" class="form-control-plaintext text-center text-dark" id="status" readonly></td>
										  <td><button type="submit" id="updateSeatBtn" class="btn text-primary">Save</button></td>
										</tr>
									  </tbody>
									</table>
								  </div>
								  
							</form>
						</div>

						<!-- <div class="modal-footer">
							<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Close</button>
							<button type="submit" id="updateSeatBtn" class="btn btn-primary">Update</button>
						</div> -->

					</div>
				</div>
			</div>

			<div class="modal fade" id="dateModal" tabindex="-1" aria-labelledby="dateModalLabel" aria-hidden="true">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title" id="dateModalLabel">Schedule Update Details</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
						</div>

						<div class="modal-body">
							<form id="flightForm">
								<input type="hidden" name="flightId" id="flightId">
								<div class="row g-3">

									<div>
										<h5><span id="displayFromCode"></span> → <span id="displayToCode"></span> -
											<span id="displayDepartureDate"></span>
										</h5>
										<p>Sector: <span id="displayFrom"></span> - <span
												id="displayTo"></span> • <span id="displayAirline"></span> : <span
												id="displayAirlineCode"></span> - <span id="displayFlightNumber"></span>
												• Total Seats : <span id="displaySeats"></span> • <span class="text-success">Sold Seats : <span id="displaySoldSeats"></span></span>
										</p>
										<p>Departure & Arrival Time : <span id="displayDepartureTime"></span> - <span
												id="displayArrivalTime"></span></p>
										<p>Travel Date : <span class="fw-bold" id="displaydepartureDate"></span></p>
									</div>

									<div class="position-relative">
										<hr />
										<h6 class="position-absolute top-50 translate-middle start-0 bg-mode px-2 text-muted"
											style="left: 95px !important;">
											Edit Inventory Details
									</h6>

									</div>
									<!-- Row 1 -->
									<div class="col-md-4">
										<label class="form-label">Airline</label>
										<input type="text" class="form-control" id="inputAirline" disabled>
									</div>

									<div class="col-md-4">
										<label class="form-label">Flight Number</label>
										<input type="text" class="form-control" id="inputFlightNumber" disabled>
									</div>

									<div class="col-md-4">
										<label class="form-label">Travel Date</label>
										<input type="text" class="form-control dateInput" id="inputDepartureDate">
									</div>

									<div class="col-md-4">
										<label class="form-label">Departure Time</label>
										<input type="time" class="form-control" id="inputDepartureTime">
									</div>

									<div class="col-md-4">
										<label class="form-label">Arrival Date</label>
										<input type="text" class="form-control dateInput" id="inputArrivalDate">
									</div>

									<div class="col-md-4">
										<label class="form-label">Arrival Time</label>
										<input type="time" class="form-control" id="inputArrivalTime">
									</div>
								</div>
							</form>
						</div>

						<div class="modal-footer">
							<button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancel</button>
							<button type="submit" id="updateDateBtn" class="btn btn-primary">Save Inventory Details</button>
						</div>
					</div>
				</div>
			</div>

			<script>
				const seatModal = document.getElementById('seatModal');

				seatModal.addEventListener('show.bs.modal', async function (event) {
					const button = event.relatedTarget;
					const flightData = JSON.parse(button.getAttribute('data-flight'));
					console.log(flightData);

					const invDate = flightData.inventoryDates?.[0] || {};

					document.getElementById('inventoryId').value = flightData._id || '';
					document.getElementById('travelDate').value = flightData.departureDate || '';
					document.getElementById('pnr').value = invDate.pnr || '';
					document.getElementById('seatsBooked').value = `${invDate.seatsBooked || 0}/${invDate.seats  || 0}`;
					document.getElementById('totalSeats').value = invDate.seats || '';
					document.getElementById('fareAdults').value = invDate.fare?.adults || '';
					document.getElementById('fareInfants').value = invDate.fare?.infants || '';
					document.getElementById('disableBeforeDays').value = flightData.disableBeforeDeparture || '';
					document.getElementById('status').value = flightData.status || 'active';
				});

			</script>

			<script>
				document.getElementById('updateSeatBtn').addEventListener('click', async function (e) {
					e.preventDefault(); // stop form from submitting normally

					const inventoryId = document.getElementById('inventoryId').value;

					const updatedData = {
						// departureDate: document.getElementById('travelDate').value,
						inventoryDates: [{
							seats: document.getElementById('totalSeats').value,
							fare: {
								adults: document.getElementById('fareAdults').value,
								infants: document.getElementById('fareInfants').value
							}
						}],
						// disableBeforeDeparture: document.getElementById('disableBeforeDeparture').value,
						// status: document.getElementById('status').value
					};

					try {
						const response = await fetch(`/update-seats?id=${inventoryId}`, {
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify(updatedData)
						});

						if (!response.ok) {
							throw new Error('Failed to update flight');
						}

						const result = await response.json();
						alert('Flight updated successfully!');
						window.location.reload();
					} catch (error) {
						console.error('Error:', error);
						alert('Error updating flight.');
					}
				});

			</script>

			<script>
				const dateModal = document.getElementById('dateModal');

				dateModal.addEventListener('show.bs.modal', function (event) {
					const button = event.relatedTarget;
					const flightData = JSON.parse(button.getAttribute('data-flight'));

					// Fill the header fields
					document.getElementById('flightId').value = flightData._id || '';
					document.getElementById('displayFromCode').textContent = flightData.from || '';
					document.getElementById('displayToCode').textContent = flightData.to || '';
					document.getElementById('displayDepartureDate').textContent = flightData.departureDate || '';
					document.getElementById('displayAirline').textContent = flightData.stops[0]?.airline || '';
					document.getElementById('displayAirlineCode').textContent = flightData.stops[0]?.airlineCode || '';
					document.getElementById('displayFlightNumber').textContent = flightData.stops[0]?.flightNumber || '';
					document.getElementById('displaySeats').textContent = flightData.inventoryDates?.[0]?.seats || '';
					document.getElementById('displayDepartureTime').textContent = flightData.departureTime || '';
					document.getElementById('displayArrivalTime').textContent = flightData.arrivalTime || '';
					document.getElementById('displaydepartureDate').textContent = flightData.departureDate || '';
					document.getElementById('displayFrom').textContent = flightData.from || '';
					document.getElementById('displayTo').textContent = flightData.to || '';
					document.getElementById('displaySoldSeats').textContent = flightData.inventoryDates?.[0]?.seatsBooked || 0;

					// Fill form inputs
					document.getElementById('inputAirline').value = flightData.stops[0]?.airline || '';
					document.getElementById('inputFlightNumber').value = flightData.stops[0]?.flightNumber || '';
					document.getElementById('inputDepartureDate').value = flightData.departureDate || '';
					document.getElementById('inputDepartureTime').value = flightData.departureTime || '';
					document.getElementById('inputArrivalDate').value = flightData.arrivalDate || '';
					document.getElementById('inputArrivalTime').value = flightData.arrivalTime || '';
				});

			</script>

			<script>
				document.getElementById('updateDateBtn').addEventListener('click', async function (e) {
					e.preventDefault(); // prevent form from submitting normally

					const flightId = document.getElementById('flightId').value;

					const updatedData = {
						departureDate: document.getElementById('inputDepartureDate').value,
						departureTime: document.getElementById('inputDepartureTime').value,
						arrivalDate: document.getElementById('inputArrivalDate').value,
						arrivalTime: document.getElementById('inputArrivalTime').value,
					};

					try {
						const response = await fetch(`/update-dates?id=${flightId}`, {
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify(updatedData)
						});

						if (!response.ok) {
							throw new Error('Failed to update flight');
						}

						const result = await response.json();
						alert('Flight updated successfully!');
						window.location.reload();
					} catch (error) {
						console.error('Error:', error);
						alert('Error updating flight.');
					}
				});

			</script>

			<script>
				const flightModal = document.getElementById('flightModal');

				flightModal.addEventListener('show.bs.modal', function (event) {
					const button = event.relatedTarget;
					const flightData = JSON.parse(button.getAttribute('data-flight'));

					// Main flight details
					document.getElementById('flightId').value = flightData._id;
					document.getElementById('inventoryName').value = flightData.inventoryName || '';
					document.getElementById('from').value = flightData.departureName || '';
					document.getElementById('to').value = flightData.arrivalName || '';
					document.getElementById('fromCode').value = flightData.from || '';
					document.getElementById('toCode').value = flightData.to || '';
					document.getElementById('departureDate').value = flightData.departureDate || '';
					document.getElementById('arrivalDate').value = flightData.arrivalDate || '';
					document.getElementById('departureTime').value = flightData.departureTime || '';
					document.getElementById('arrivalTime').value = flightData.arrivalTime || '';
					document.getElementById('duration').value = flightData.duration || '';
					document.getElementById('fromCity').value = flightData.fromCity || '';
					document.getElementById('toCity').value = flightData.toCity || '';
					document.getElementById('fromCountry').value = flightData.fromCountry || '';
					document.getElementById('toCountry').value = flightData.toCountry || '';

					// Clear existing stops if any
					const stopsContainer = document.getElementById('stopsContainer');
					stopsContainer.innerHTML = '';

					// Add stops dynamically
					if (flightData.stops && flightData.stops.length > 0) {
						flightData.stops.forEach((stop, index) => {
							const stopHTML = `
				<div class="col-12"><hr><strong>Stop ${index}</strong></div>
				<div class="col-md-4">
				  <label class="form-label">From</label>
				  <input type="text" class="form-control stop-from" value="${stop.from || ''}" >
				</div>
				<div class="col-md-4">
				  <label class="form-label">To</label>
				  <input type="text" class="form-control stop-from" value="${stop.to || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">From Code</label>
				  <input type="text" class="form-control stop-from-code" value="${stop.fromCode || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">To Code</label>
				  <input type="text" class="form-control stop-to-code" value="${stop.toCode || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">From Terminal</label>
				  <input type="text" class="form-control stop-from-terminal" value="${stop.fromTerminal || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">To Terminal</label>
				  <input type="text" class="form-control stop-to-terminal" value="${stop.toTerminal || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Flight Number</label>
				  <input type="text" class="form-control stop-flight-number" value="${stop.flightNumber || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Airline</label>
				  <input type="text" class="form-control stop-airline" value="${stop.airline || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Departure Date</label>
				  <input type="text" class="form-control stop-departure-day dateInput" value="${stop.departureDay || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Arrival Date</label>
				  <input type="text" class="form-control stop-arrival-day dateInput" value="${stop.arrivalDay || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Departure Time</label>
				  <input type="time" class="form-control stop-departure-time" value="${stop.departureTime || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Arrival Time</label>
				  <input type="time" class="form-control stop-arrival-time" value="${stop.arrivalTime || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Stop Duration (in sec)</label>
				  <input type="text" class="form-control stop-duration" value="${stop.stopDuration || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Departure City</label>
				  <input type="text" class="form-control stop-departure-city" value="${stop.departureCity || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Arrival City</label>
				  <input type="text" class="form-control stop-arrival-city" value="${stop.arrivalCity || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Airline Code</label>
				  <input type="text" class="form-control stop-airline-code" value="${stop.airlineCode || ''}" >
				</div>
				<div class="col-md-3">
				  <label class="form-label">Airline Logo</label>
				  <input type="text" class="form-control stop-airline-logo" value="${stop.airlineLogo || ''}" >
				</div>
			  `;
							stopsContainer.insertAdjacentHTML('beforeend', stopHTML);
						});
					}

					// Pricing and baggage
					const invDate = flightData.inventoryDates?.[0] || {};
					document.getElementById('pnr').value = invDate.pnr || '';
					document.getElementById('seats').value = invDate.seats || '';
					document.getElementById('adults').value = invDate.fare?.adults || '';
					document.getElementById('infants').value = invDate.fare?.infants || '';
					document.getElementById('cab').value = flightData.baggage?.adult?.cabin?.weightPerPiece || '';
					document.getElementById('checkin').value = flightData.baggage?.adult?.checkIn?.weightPerPiece || '';

					// Status
					document.getElementById('status').value = flightData.status || 'inactive';
				});
			</script>

			<script>
				document.getElementById('updateFlightBtn').addEventListener('click', async function () {
					const form = document.getElementById('flightForm');

					const getValue = (id) => document.getElementById(id)?.value || '';
					const flightId = getValue('flightId');

					const stopBlocks = document.querySelectorAll('.stop-block');
					const stops = [];

					stopBlocks.forEach((block, index) => {
						stops.push({
							from: block.querySelector('.stop-from')?.value || '',
							to: block.querySelector('.stop-to')?.value || '',
							fromCode: block.querySelector('.stop-from-code')?.value || '',
							toCode: block.querySelector('.stop-to-code')?.value || '',
							fromTerminal: block.querySelector('.stop-from-terminal')?.value || '',
							toTerminal: block.querySelector('.stop-to-terminal')?.value || '',
							flightNumber: block.querySelector('.stop-flight-number')?.value || '',
							airline: block.querySelector('.stop-airline')?.value || '',
							departureDay: block.querySelector('.stop-departure-day')?.value || '',
							arrivalDay: block.querySelector('.stop-arrival-day')?.value || '',
							departureTime: block.querySelector('.stop-departure-time')?.value || '',
							arrivalTime: block.querySelector('.stop-arrival-time')?.value || '',
							stopDuration: block.querySelector('.stop-duration')?.value || '',
							departureCity: block.querySelector('.stop-departure-city')?.value || '',
							arrivalCity: block.querySelector('.stop-arrival-city')?.value || '',
							airlineCode: block.querySelector('.stop-airline-code')?.value || '',
							airlineLogo: block.querySelector('.stop-airline-logo')?.value || ''
						});
					});

					const flightData = {
						flightId: getValue('flightId'),
						inventoryName: getValue('inventoryName'),
						from: getValue('fromCode'),
						to: getValue('toCode'),
						departureName: getValue('from'),
						arrivalName: getValue('to'),
						departureDate: getValue('departureDate'),
						arrivalDate: getValue('arrivalDate'),
						departureTime: getValue('departureTime'),
						arrivalTime: getValue('arrivalTime'),
						duration: getValue('duration'),
						fromCity: getValue('fromCity'),
						toCity: getValue('toCity'),
						fromCountry: getValue('fromCountry'),
						toCountry: getValue('toCountry'),
						stops: stops,
						inventoryDates: [{
							pnr: getValue('pnr'),
							seats: getValue('seats'),
							fare: {
								adults: getValue('adults'),
								infants: getValue('infants'),
							}
						}],
						baggage: {
							adult: {
								cabin: { weightPerPiece: getValue('cab') },
								checkIn: { weightPerPiece: getValue('checkin') }
							}
						},
						status: getValue('status'),
					};

					try {
						const response = await fetch(`/update-listing?id=${flightId}`, {
							method: 'PUT',
							headers: {
								'Content-Type': 'application/json'
							},
							body: JSON.stringify(flightData)
						});

						if (!response.ok) {
							throw new Error('Failed to update flight');
						}

						const result = await response.json();
						alert('Flight updated successfully!');
						window.location.reload();
					} catch (error) {
						console.error('Error:', error);
						alert('Error updating flight.');
					}
				});
			</script>

			<script>
				function initFlatpickrOnNewDateInputs(container) {
					container.querySelectorAll(".dateInput:not(.flatpickr-input)").forEach(input => {
						flatpickr(input, {
							dateFormat: "d M Y",
							defaultDate: "today",
							allowInput: true
						});
					});
				}

			</script>

			<script>
				document.addEventListener("DOMContentLoaded", () => {

					document.querySelectorAll('.changeStatusToggle').forEach(toggle => {
						toggle.addEventListener('change', async function (event) {
							const flightId = this.getAttribute('data-id');
							const newStatus = this.getAttribute('data-status');

							if (!flightId || !newStatus) {
								console.error('Missing flight ID or status.');
								return;
							}

							// ⚡ Ask for confirmation before proceeding
							const confirmChange = confirm(`Are you sure you want to change the status to "${newStatus}"?`);
							if (!confirmChange) return;

							console.log('Flight ID:', flightId);
							console.log('New Status:', newStatus);
							try {
								const response = await fetch('/update-status', {
									method: 'PUT',
									headers: {
										'Content-Type': 'application/json'
									},
									body: JSON.stringify({
										flightId: flightId,
										newStatus: newStatus
									})
								});

								if (!response.ok) {
									throw new Error('Status update failed');
								}

								alert('Status updated successfully!');
							} catch (err) {
								alert('Error updating status');
								this.checked = !this.checked; // Revert if error
							}
						});
					});

				});
			</script>

			<script>
				document.addEventListener('DOMContentLoaded', function () {
					flatpickr(".dateInput", {
						dateFormat: "d M Y",
						defaultDate: "today",
						allowInput: true
					});
				});
			</script>

			<script>
				document.querySelectorAll('.user-booking-btn').forEach(button => {
					button.addEventListener('click', function (e) {
						e.preventDefault();

						const flightId = this.getAttribute('data-flight-id');

						if (flightId) {
							window.location.href = `/user-bookings?flightId=${flightId}`;
						} else {
							alert('Flight ID missing.');
						}
					});
				});
			</script>

			<!-- <style>
				.custom-switch {
					position: relative;
					display: inline-block;
					width: 75px;
					height: 36px;
				}

				.custom-switch input {
					opacity: 0;
					width: 0;
					height: 0;
				}

				.slider {
					position: absolute;
					top: 0;
					left: 0;
					right: 0;
					bottom: 0;
					background-color: #ccc;
					border-radius: 36px;
					transition: 0.4s;
					display: flex;
					align-items: center;
					justify-content: center;
					font-weight: bold;
					font-size: 14px;
					color: white;
				}

				.slider::before {
					content: "";
					position: absolute;
					height: 28px;
					width: 28px;
					left: 4px;
					bottom: 4px;
					background-color: white;
					border-radius: 50%;
					transition: 0.4s;
					z-index: 1;
				}

				.label-on,
				.label-off {
					position: absolute;
					width: 100%;
					/* text-align: center; */
					z-index: 0;
					transition: opacity 0.3s;
				}

				.label-on {
					opacity: 0;
					text-align: left;
				}

				.label-off {
					opacity: 1;
					text-align: right;
				}

				input:checked+.slider {
					background-color: #28a745;
				}

				input:checked+.slider::before {
					transform: translateX(44px);
				}

				input:checked+.slider .label-on {
					opacity: 1;
				}

				input:checked+.slider .label-off {
					opacity: 0;
				}
			</style> -->
		<style>
			.custom-switch {
    position: relative;
    display: inline-block;
    width: 40px;
    height: 20px;
}

.custom-switch input {
    opacity: 0;
    width: 0;
    height: 0;
}

.slider {
    position: absolute;
    cursor: pointer;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: #ccc;
    transition: 0.4s;
    border-radius: 20px;
}

.slider:before {
    position: absolute;
    content: "";
    height: 14px;
    width: 14px;
    left: 3px;
    bottom: 3px;
    background-color: white;
    transition: 0.4s;
    border-radius: 50%;
}

input:checked + .slider {
    background-color: #4caf50;
}

input:checked + .slider:before {
    transform: translateX(20px);
}

		</style>
		
		</main>
		<!-- **************** MAIN CONTENT END **************** -->

		<%- include('./partials/footer') %>